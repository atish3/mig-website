{% load my_markdown %}
{% url 'event_cal:event_detail' event.id as event_page %}
<div style="position:relative;">
{% if event_page != request.path %}
<a href="{{event_page}}"><h3>{{event.name}}</h3></a>
{% else %}
<h3>{{event.name}}</h3>
{% endif %}
{% if can_edit_event %}
<div class="location-upper-right">
<a href="{% url 'event_cal:edit_event' event.id %}"><i class="icon-edit"></i> Edit</a>
<a href="{% url 'event_cal:delete_event' event.id %}"><i class="icon-remove"></i> Delete</a>
</div>
{% endif %}
<p><b>Event/Requirement Type:</b> {{event.event_type}}</p>
<p class="text-justify">{{event.description|capfirst|my_markdown}}</p>
<p><b>Project Leaders: </b>
{% for leader in event.leaders.all %}
<a href="{% url 'member_resources:profile' leader.uniqname %}">{{ leader }}</a>{% if event.leaders.all|length > 2 and not forloop.last %}, {% endif %}{% if event.leaders.all|length > 1 and forloop.revcounter == 2 %} and {% endif %}{% endfor %}</p>
{% if event.eventshift_set.all|length < 2 %}
{% for shift in event.eventshift_set.all|dictsort:"start_time" %}
{% with total_attending=shift.attendees.count %}
<div id="event-shift">
	<p id="event-when"><b>When:</b> {{shift.start_time|date:"D. N d, Y P" }}&ndash;{% if shift.start_time|date:"N d Y" != shift.end_time|date:"N d Y" %}{{shift.end_time|date:"D. N d, Y P"}}{% else %}{{shift.end_time|date:"P"}}{% endif %}</p>
    <p id="event-where"><b>Where:</b> {{shift.location}}{% if shift.on_campus%} (on campus){% else %} (off campus){%endif%}</p>
    {% if user.is_authenticated and has_profile %}
        {% if user.userprofile not in shift.attendees.all %}
            {% if shift.max_attendance != None %}
                {% if shift.start_time >= now and total_attending < shift.max_attendance %}
                    <p><a class="btn btn-small" href="{% url 'event_cal:sign_up' event.id shift.id %}"><i class="icon-ok"></i> Sign-up</a></p>
                {% elif shift.start_time < now %}
                    <p>Sign-up is closed.</p>
                {% else %}
                    <p>Event is full.</p>
                {% endif %}
            {% else %}
                {% if event.is_meeting %}
                    {% if shift.start_time|add:before_grace > now %}
                        <p>Sign-in is closed until the meeting starts.</p>
                    {% elif  shift.end_time|add:after_grace < now %}
                        <p>Sign in is closed after the meeting ends.</p>
                        <p>{{now}}</p>
                    {% else %}
                    <p><a class="btn btn-small" href="{% url 'event_cal:meeting_sign_in' event.id shift.id %}"><i class="icon-ok"></i> Sign-in to {{event.name}}</a></p>
                    {% endif %}
                {% else %}
                    {% if shift.start_time >= now %}
                        <p><a class="btn btn-small" href="{% url 'event_cal:sign_up' event.id shift.id %}"><i class="icon-ok"></i> Sign-up</a></p>
                    {% else %} 
                        <p>Sign-up is closed.<p>
                        {% endif %}
                    {% endif %}
            {% endif %}
        {% else %}
            {% if shift.start_time >= now %}
                <p><a class="btn btn-small" href="{% url 'event_cal:unsign_up' event.id shift.id %}"><i class="icon-remove"></i> Unsign-up</a></p>
            {% elif event.is_meeting %}
                <p>You are already signed in.</p>
            {% else %}
                <p>You cannot unsign-up after an event starts.</p>
            {% endif %}
        {% endif %}
    {% elif user.is_authenticated %}
        <p>You must create a profile to sign-up</p>
    {% else %}
        <p>You must login to sign-up</p>
    {% endif %}
    <p><b>Attendees:</b><p>
    {% if full_view and has_profile%} 
    <ul>
        {% for attendee in shift.attendees.all %}
            {% url 'member_resources:profile' attendee.uniqname as profile_url %}
            <li>
            {% if attendee.is_member %}
                <a href="{{profile_url}}">{{attendee}}</a>
            {% else %}
                <p>{{attendee}}</p>
            {% endif %}
            </li>
        {% endfor %}
    </ul>
    <p>Total:</p>
    {% endif %}
    {% if shift.max_attendance != None %}
        <p>{{total_attending}} of {{shift.max_attendance}} spots.</p>
    {% else %}
        <p>{{total_attending}} (no limit)</p>
    {% endif %}

</div>
{% endwith %}
{% endfor %}
{% else %}
<div class="accordion" id="shifts{{ event.id }}">
    <div class="accordion-group">
        <div class="accordion-heading">
            <a class="accordion-toggle" data-toggle="collapse" data-parent="#shifts{{ event.id }}" href="#shiftscol{{ event.id }}">
                <h5>Shifts</h5>
            </a>
        </div>
        <div id="shiftscol{{ event.id }}" class="accordion-body collapse{% if event.id == event_signed_up %} in{% endif %}">
            <div class="accordion-inner">
                <table class="table table-striped">
                    <tr>
                        <th>Start Time</th>
                        <th>End Time</th>
                        <th>Location</th> 
                        <th>Attendees</th>
                        <th>Sign-up for shift</th>
                        {% if can_edit_event %}
                            <th></th>
                        {% endif %}
                    </tr>
                    {% for shift in event.eventshift_set.all|dictsort:"start_time" %}
                    {% if not only_mine or user.userprofile in shift.attendees.all %}
                    {% with total_attending=shift.attendees.count %}
                        <tr>
                            <td>{{ shift.start_time|date:"D. N d, Y P" }}</td>
                            <td>{{ shift.end_time|date:"D. N d, Y P" }}</td>
                            <td>{{ shift.location}}{% if shift.on_campus%} (on campus){% else %} (off campus){%endif%}</td>
                            <td>
                            {% if full_view and has_profile %} 
                                <ul>
                                {% for attendee in shift.attendees.all %}
                                    {% url 'member_resources:profile' attendee.uniqname as profile_url %}
                                    <li>
                                    {% if attendee.is_member %}
                                        <a href="{{profile_url}}">{{attendee}}</a>
                                    {% else %}
                                        <p>{{attendee}}</p>
                                    {% endif %}
                                    </li>
                                {% endfor %}
                                </ul>
                            {% endif %}
                            {% if shift.max_attendance != None %}
                                <p>{{total_attending}} of {{shift.max_attendance}} spots.</p>
                            {% else %}
                                <p>{{total_attending}} (no limit)</p>
                            {% endif %}
                            </td>
                            {% if user.is_authenticated and has_profile %}
                            {% if user.userprofile not in shift.attendees.all %}
                                {% if shift.max_attendance != None %}
                                    {% if shift.start_time >= now  and total_attending < shift.max_attendance %}
                                        <td><a class="btn btn-small" href="{% url 'event_cal:sign_up' event.id shift.id %}"><i class="icon-ok"></i> Sign-up</a></td>
                                    {% elif shift.start_time < now %}
                                        <td>Sign-up is closed</td>
                                    {% else %}
                                        <td>Shift is full.</td>
                                    {% endif %}
                                {% else %}
                                    {% if shift.start_time >= now %}
                                        <td><a class="btn btn-small" href="{% url 'event_cal:sign_up' event.id shift.id %}"><i class="icon-ok"></i> Sign-up</a></td>
                                    {% else %}
                                        <td>Sign-up is closed.</td>
                                    {% endif %}
                                {% endif %}
                            {% else %}
                                {% if shift.start_time >= now %}
                                    <td><a class="btn btn-small" href="{% url 'event_cal:unsign_up' event.id shift.id %}"><i class="icon-remove"></i>Unsign-up</a></td>
                                {% else %}
                                    <td>You cannot unsign-up after an event starts.</td>
                                {% endif %}
                            {% endif %}
                            {% elif user.is_authenticated %}
                                <td>You must create a profile to sign-up</td>
                            {% else %}
                                <td>You must login to sign-up
                            {% endif %}
                            {% if can_edit_event %}
                                <td><a class="btn btn-small" href="{% url 'event_cal:delete_shift' event.id shift.id %}"><i class="icon-remove"></i> Delete shift</a></td>
                            {% endif %}
                        </tr>
                    {% endwith %}
                    {% endif %}
                    {% endfor %}
                </table>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% if full_view and can_edit_event and event.needs_carpool %}
{% regroup event.carpoolperson_set.all|dictsort:"get_role_display" by get_role_display as carpool_list %}
{% for role in carpool_list %}
    <h4>{{role.grouper}}</h4>
    <table class="table table-striped table-bordered">
    <thead>
        <tr>
            <th>Person</th>
            {% if role.grouper == 'Driver' %}
            <th> Number seats</th>
            {% endif %}
            <th>Location</th>
        </tr>
    </thead>
    <tbody>
        {% for person in role.list %}
        <tr>
            <td>{{person.person}}</td>
            {% if role.grouper == 'Driver' %}
            <td> {{person.number_seats}}</td>
            {% endif %}
            <td>{{person.get_location_display}}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endfor %}
{% endif %}

</div>
